**Extraction of the lake connections.** In the next step we compute a set of trees $T_{L}$ covering $G_{L}$ . This step is analogous to the stream tree calculation, but this time we model the fow between lakes. Unfortunately, this cannot be done in the same way as for $G$ , because there is no height ordering in the lake graph $G_{L}$

In the first step (Figure 6) we initialize $T_{L}$ with nodes $l\in G_{L}$ such that ${\mathcal{N}_{l}}$ belongs to the border of $S2$ and we remove all arcs leaving them. These nodes correspond to river mouths where water flows out of the region of interest. Then, we progressively extend the trees $T_{L}$ towards the interior of $S2$ ..We say that an arc $e(i,j)\notin T_{L}$ is a candidate if it captures the flow from a node $i\notin T_{L}$ towards node $j\in T_L$ . We parse the set of candidate arcs $\{e(i,j)\}$ in increas ing pass height order; adding $e^{\circ}$ and the flowing lake $i$ to $T_{L}$ . The set of candidate arcs is updated after each step of the parsing

Figure 6: Lake connections $G_{L}.$ Left: arcs leaving external nodes (dark blue)are removed.Incoming arcs are candidates to $T_{L}$ (green).Middle:Weadd the candidate arc e thathas the lowest pass height and its flowing lake $N$ to the tree $T_{L}$ The unused can didate arcs areremoved from $G_{L}$ Right:Trees of lakes after con vergence with all arcs numbered in theparsing order

The tree structure is guaranteed to be consistent and coherent under the condition that we cannot add an arc flowing from a previously added node. We remove the unused candidate arcs from $G_{L}$ and we use a red-black tree for labeling and sorting the set of candidate arcs. Let $M$ denote the number of lakes. A first $O(N)$ pass on the graph is performed. Then our algorithm needs at most $M$ evaluations in a red-black tree of size $M$ , which guarantees a complexity of $O(N+M\log(M))$ .The number of lakes $M$ is usually much lower than the number of nodes $N$ . The experimental speedup compared to the $O(N\sqrt{N})$ version is noticeable in the first iterations where the local minima are numerous.

Figure 7: An arc $e(i,j)$ in $T_{L}$ (left) is converted into an arc in $\tilde{T}$ by connecting the bottom of the lake i ($\mathcal{N}_{i}$ in $\mathcal{G}$) to the pass belonging to lake j ($X_{j}$ in $\mathcal{G}_{i}$)

**Stream tree update** generates a new version of 7 denoted as $\tilde{T}$ which includes the pass information from the previous step. Re call that a node of $TL$ is identified by the index $i$ of the root of a stream tree $M_{i}$ in $G$ . Moreover, an arc $e(i,j)$ of $G_{L}$ is associated to a pass $({\mathcal{X}}_{i},{\mathcal{X}}_{j})$ , where $X_{j}$ is a node of $G$ at the side of the pass belonging to lake $j$

During this merging step, we add an arc $e({\mathcal X}_{i},{\mathcal X}_{j})\in{\mathcal G}$ for each arc $e(i,j)\in G_{L}$ (Figure 7). After this step all water flowing into i will flow toward $j$ through the node $X_{j}$ of the pass.
